#!/usr/bin/env bash
#: Title: crc-config - CRUD for configuration files
#: Date: 2019-04-23
#: Version: 0.1.0
#: Author: "Alex Y" <aleksandryackovlev@yandex.ru>
#: Description: CRUD for configuration files

[[ $crcConfigLoaded ]] && return

source ./crc-env
source ./crc-utils

# DESCRIPTION: Sources the global config file if it exists
# USAGE: readGlobalConfig
readGlobalConfig() {
  if [[ -f $(crc-env globalConfigFile) ]]; then
    source "$(crc-env globalConfigFile)"
  fi
}

# DESCRIPTION: Sources the local config file if it exists
# USAGE: readLocalConfig
readLocalConfig() {
  local currentDir
  local localConfigFile

  currentDir="$PWD"
  localConfigFile="$currentDir/$(crc-env configFileName)"


  while [[ ! $currentDir = "$HOME" && -n $currentDir && ! -f $localConfigFile ]]; do 
    printf "%s\n" "$currentDir" "$localConfigFile"

    currentDir="${currentDir%/*}"
    localConfigFile="$currentDir/$(crc-env configFileName)"
  done

  if [[ -f $localConfigFile ]]; then
    source "$localConfigFile"
  fi
}

# DESCRIPTION: Sources the both config files if they exist
# USAGE: readConfig
readConfig() {
  readGlobalConfig
  readLocalConfig
}

# DESCRIPTION: The entry point for the crc-config
# USAGE: crc-config COMMAND
crc-config() {
  local commandToExec
  commandToExec="$1"
  shift

  case $commandToExec in
    read)
        readConfig "$@"
      ;;
    *)
        crc-utils die "$(crc-env misuseErrorCode)" "An unknown command crc-config ""$commandToExec"
      ;;
  esac
}

crcConfigLoaded=1
